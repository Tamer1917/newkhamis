import logging
import firebase_admin
from firebase_admin import credentials, firestore
from telegram import Update
from telegram.ext import Application, CommandHandler, CallbackContext

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
cred = credentials.Certificate(r"C:\Users\LENOVO\Desktop\therapp\serviceAccountKey.json")
firebase_admin.initialize_app(cred)
db = firestore.client()

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
TELEGRAM_TOKEN = "7996338110:AAGKkgFy1qpUQG4E9A4ZJrgc0aon4cx8JpI"
HTML_PAGE_URL = "https://wednsdaychess.vercel.app"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                    level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ØªØªÙ… Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
async def start(update: Update, context: CallbackContext):
    user = update.message.from_user
    user_id = user.id
    username = user.username if user.username else f"User{user_id}"  # ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…
    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    user_ref = db.collection('users').document(str(user_id))
    doc = user_ref.get()

    if doc.exists:
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
        user_data = doc.to_dict()
        points = user_data.get("points", 0)
    else:
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
        points = 5  # Ø¥Ø¶Ø§ÙØ© 5 Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        user_ref.set({
            'username': username,
            'points': points
        })

    # ØªÙƒÙˆÙŠÙ† Ø±Ø§Ø¨Ø· ØµÙØ­Ø© HTML Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    url = f"{HTML_PAGE_URL}?username={username}&points={points}"
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await update.message.reply_text(f"Ù…Ø±Ø­Ø¨Ù‹Ø§ {username}!\nØ¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·: {points}\n\nğŸ“Œ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„: [Ø§Ø¶ØºØ· Ù‡Ù†Ø§]({url})", parse_mode="Markdown")

# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    
    application.run_polling()

if __name__ == '__main__':
    main()
